name: ðŸ¤– Gerar DocumentaÃ§Ã£o

on:
  # Dispara em Pull Requests para branches principais  
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]
  
  # Dispara em pushes para branch principal
  push:
    branches: [ main, master, develop ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'mobile/**'
      - 'automation/**'
      - '**.md'
      - '**.json'
      - '.github/workflows/**'
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Tipo de anÃ¡lise'
        required: false
        default: 'full'
        type: choice
        options:
        - full
        - technical
        - user
        - executive

# PermissÃµes necessÃ¡rias
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  generate-docs:
    name: ðŸ“š Gerar DocumentaÃ§Ã£o
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ï¿½ Debug - Workflow iniciado
        run: |
          echo "âœ… Workflow executando com sucesso!"
          echo "ðŸ“Š InformaÃ§Ãµes do ambiente:"
          echo "   - Runner OS: ${{ runner.os }}"
          echo "   - GitHub Event: ${{ github.event_name }}"
          echo "   - Branch: ${{ github.ref_name }}"
          echo "   - Repository: ${{ github.repository }}"
          echo "   - Timestamp: $(date)"

      - name: ï¿½ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.TOKEN_GITHUB }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ§¹ Limpar cache do npm
        run: npm cache clean --force

      - name: ðŸ“¦ Instalar dependÃªncias
        working-directory: ./automation
        run: |
          echo "ðŸ”„ Instalando dependÃªncias..."
          if npm ci --no-audit --progress=false; then
            echo "âœ… DependÃªncias instaladas com npm ci"
          else
            echo "âš ï¸ npm ci falhou, tentando npm install..."
            rm -rf node_modules package-lock.json
            npm cache clean --force
            npm install --no-audit --progress=false
            echo "âœ… DependÃªncias instaladas com npm install"
          fi

      - name: ðŸ” Verificar variÃ¡veis de ambiente
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}
        run: |
          echo "ðŸ” Verificando configuraÃ§Ãµes..."
          
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "âŒ OPENAI_API_KEY nÃ£o configurada"
            echo "ðŸ“ Configure em: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          echo "âœ… OpenAI API Key configurada (${#OPENAI_API_KEY} caracteres)"
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ TOKEN_GITHUB nÃ£o configurado" 
            echo "ðŸ“ Configure em: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          echo "âœ… GitHub Token configurado (${#GITHUB_TOKEN} caracteres)"
          
          echo "ðŸ“Š Contexto do evento:"
          echo "   Evento: ${{ github.event_name }}"
          echo "   Branch: ${{ github.ref_name }}"
          echo "   Repository: ${{ github.repository }}"
          echo "   Working Directory: $(pwd)"
          
          echo "ðŸ“ Verificando estrutura de arquivos:"
          ls -la automation/ || echo "âŒ Pasta automation nÃ£o encontrada"

      - name: ðŸ¤– Executar anÃ¡lise de cÃ³digo
        working-directory: ./automation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ðŸš€ Iniciando anÃ¡lise..."
          node scripts/analyze-code.js
        
      - name: ðŸ“Š Resumo da execuÃ§Ã£o
        if: always()
        run: |
          echo "## ðŸ“‹ Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "automation/logs/analysis-*.json" ]; then
            LATEST_LOG=$(ls -t automation/logs/analysis-*.json | head -1)
            echo "ðŸ“ˆ **EstatÃ­sticas:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat "$LATEST_LOG" | jq '.stats' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Nenhum log de anÃ¡lise encontrado" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Links Ãšteis:**" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“š Wiki do Projeto](../../wiki)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‹ Issues](../../issues)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ¤– Workflows](../../actions)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Comentar no PR (se aplicÃ¡vel)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Procurar pelo log mais recente
            const logsDir = path.join(process.cwd(), 'automation/logs');
            let logContent = null;
            
            try {
              const logFiles = fs.readdirSync(logsDir)
                .filter(file => file.startsWith('analysis-') && file.endsWith('.json'))
                .sort()
                .reverse();
              
              if (logFiles.length > 0) {
                const latestLog = path.join(logsDir, logFiles[0]);
                logContent = JSON.parse(fs.readFileSync(latestLog, 'utf8'));
              }
            } catch (error) {
              console.log('NÃ£o foi possÃ­vel ler logs:', error.message);
            }
            
            const commentBody = `## ðŸ¤– DocumentaÃ§Ã£o Atualizada
            
            A documentaÃ§Ã£o foi atualizada automaticamente baseada nas mudanÃ§as deste PR.
            
            ### ðŸ“Š EstatÃ­sticas
            ${logContent ? `
            - **Arquivos analisados**: ${logContent.stats.processedFiles}
            - **Total de tokens**: ${logContent.stats.totalTokens}
            - **Custo estimado**: $${logContent.stats.totalCost.toFixed(4)}
            ` : '- EstatÃ­sticas nÃ£o disponÃ­veis'}
            
            ### ðŸ”— Links da DocumentaÃ§Ã£o
            - [ðŸ“š DocumentaÃ§Ã£o TÃ©cnica](../../wiki/ðŸ“š-DocumentaÃ§Ã£o-TÃ©cnica)
            - [ðŸ‘¥ Guia do UsuÃ¡rio](../../wiki/ðŸ‘¥-Guia-do-UsuÃ¡rio)
            - [ðŸ“ˆ Resumo Executivo](../../wiki/ðŸ“ˆ-Resumo-Executivo)
            
            ### ðŸ“‹ PrÃ³ximos Passos
            - [ ] Revisar documentaÃ§Ã£o gerada
            - [ ] Validar precisÃ£o das informaÃ§Ãµes
            - [ ] Considerar feedback da equipe
            
            ---
            *Gerado automaticamente pelo Sistema de DocumentaÃ§Ã£o Inteligente*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: ðŸ—‚ï¸ Fazer upload dos logs (para debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-logs-${{ github.run_number }}
          path: automation/logs/
          retention-days: 30
          if-no-files-found: ignore

  # Job adicional para verificar saÃºde do sistema
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: generate-docs
    if: always()
    
    steps:
      - name: ðŸ“ˆ Verificar status do sistema
        run: |
          echo "## ðŸ¥ Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.generate-docs.result }}" == "success" ]; then
            echo "âœ… **Sistema funcionando corretamente**" >> $GITHUB_STEP_SUMMARY
            echo "- AnÃ¡lise de cÃ³digo: âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- GeraÃ§Ã£o de documentaÃ§Ã£o: âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- AtualizaÃ§Ã£o do Wiki: âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Sistema com problemas**" >> $GITHUB_STEP_SUMMARY
            echo "- Status: ${{ needs.generate-docs.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Verificar logs para mais detalhes" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **MÃ©tricas:**" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“§ Notificar sobre falhas (opcional)
        if: failure()
        run: |
          echo "ðŸš¨ Sistema de documentaÃ§Ã£o apresentou falhas!"
          echo "Verificar logs e configuraÃ§Ãµes."
          # Aqui poderia adicionar notificaÃ§Ã£o via email, Slack, etc.
